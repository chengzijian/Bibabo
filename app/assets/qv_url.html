<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <!--普通视频 /qqvideo.html?vid=l0024si3r7q&guid=70172a7b5122e521f8ddb7836b6cf5a6&platform=10901&sdtfrom=v1010&defn=shd&ehost=https://v.qq.com/tv/p/topic/cqzzt/index.html&timestamp=-->
    <!--短的动画视频 /qqvideo.html?vid=n0020yrnly7&guid=9292fbe6a29f78d1dad9b3ad2c26c714&platform=10901&sdtfrom=v1010&defn=shd&ehost=&timestamp=-->
    <!--长的动画视频/qqvideo.html?vid=a0022vkdxum&guid=9292fbe6a29f78d1dad9b3ad2c26c714&platform=10901&sdtfrom=v1010&defn=shd&ehost=&timestamp=-->
    <!--http://imgcache.qq.com/tencentvideo_v1/tvp/js/tvp.player_v2_jq.js-->
    <script src="http://libs.baidu.com/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var vid = getQueryString("vid");
        var guid = getQueryString("guid");
        var platform = getQueryString("platform");
        var sdtfrom = getQueryString("sdtfrom");
        var timestamp = getQueryString("timestamp");
        var ehost = getQueryString("ehost");
        var defn = getQueryString("defn");
        var filename = getQueryString("filename");
        var format = getQueryString("format");

        var _urlStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        var d = ("" + 1).charAt(0);
        var g = "";
        var h = "";
        var seed = "#$#@#*ad";

        function userClick(index) {
            <!--writeObj(tvp.$);-->
            <!--$("#get_info_div").append(createGUID());-->

            $("#get_info_div").append(vid);
            $("#get_info_div").append(guid);
            $("#get_info_div").append(platform);
            $("#get_info_div").append(sdtfrom);
            $("#get_info_div").append(timestamp);
            $("#get_info_div").append("</br>");
        }

        function writeObj(obj){
            var description = "";
            for(var i in obj){
                var property=obj[i];
                description+=i+" = "+property+"\n";
            }
            $("#get_info_div").append(description);
        }

        function getKeyInfo(){
            var url = getUrlEnc();
            var qv_rmt = u1(url, 0);
            var qv_rmt2 = u1(url, 1);

            var keyUrl = "https://vv.video.qq.com/getkey?otype=json";
            keyUrl +="&vid="+vid;
            keyUrl +="&format="+format;
            keyUrl +="&filename="+filename;
            keyUrl +="&platform="+platform;
            keyUrl +="&appVer=3.2.21";
            keyUrl +="&vt=203";
            keyUrl +="&sdtfrom="+sdtfrom;
            keyUrl +="&guid="+guid;
            keyUrl +="&charge=0";
            keyUrl +="&_rnd="+timestamp;
            keyUrl +="&_qv_rmt="+qv_rmt;
            keyUrl +="&_qv_rmt2="+qv_rmt2;
            keyUrl +="&_";
            keyUrl +=timestamp;
            keyUrl +="000=";

            $("#get_key_div").append(keyUrl);
        }

        function getUrlEnc(){
            guid = guid || createGUID();
            platform = platform || "10901";
            sdtfrom = sdtfrom || "v1010";
            timestamp = timestamp || parseInt(+new Date / 1e3);
            filename = filename || "";
            format = format || "";
            var key = platform + vid + timestamp + seed + g + h + d + sdtfrom;
            var temp = tempcalc(hexToString(haha(key)), seed);
            var url = urlenc(temp, d.charAt(0), timestamp);
            return url;
        }

        function getVideoInfo() {
            var url = getUrlEnc();
            var qv_rmt = u1(url, 0);
            var qv_rmt2 = u1(url, 1);

            var infoUrl = "https://vv.video.qq.com/getinfo?charge=0";
            infoUrl +="&defaultfmt=auto";
            infoUrl +="&otype=json";
            infoUrl +="&defnpayver=1";
            infoUrl +="&appVer=3.2.20";
            infoUrl +="&sdtfrom="+sdtfrom;
            infoUrl +="&host=v.qq.com";
            infoUrl +="&sphttps=1";
            infoUrl +="&spwm=2";
            infoUrl +="&fhdswitch=1";
            infoUrl +="&show1080p=1";
            infoUrl +="&isHLS=0";
            infoUrl +="&defsrc=2";
            infoUrl +="&vid="+vid;
            infoUrl +="&guid="+guid;
            infoUrl +="&platform="+platform;
            infoUrl +="&newplatform="+platform;
            infoUrl +="&ehost="+ehost;
            infoUrl +="&_rnd="+timestamp;
            infoUrl +="&defn="+defn;
            infoUrl +="&_qv_rmt="+qv_rmt;
            infoUrl +="&_qv_rmt2="+qv_rmt2;
            infoUrl +="&_";
            infoUrl +=timestamp;
            infoUrl +="000=";
            $("#get_info_div").append(infoUrl);
        }

        function getQueryString(name) {
             var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
             var r = window.location.search.substr(1).match(reg);
             if(r!=null)return  unescape(r[2]); return "";
        }

        haha = function(a) {
            function b(a, b) {
                return ((a >> 1) + (b >> 1) << 1) + (1 & a) + (1 & b)
            }
            for (var c = [], d = 0; 64 > d;) c[d] = 0 | 4294967296 * Math.abs(Math.sin(++d));
            var e = function(d) {
                    for (var e, f, g, h, i = [], j = unescape(encodeURI(d)), k = j.length, l = [e = 1732584193, f = -271733879, ~e, ~f], m = 0; k >= m;) i[m >> 2] |= (j.charCodeAt(m) || 128) << 8 * (m++ % 4);
                    for (i[d = (k + 8 >> 6) * a + 14] = 8 * k, m = 0; d > m; m += a) {
                        for (k = l, h = 0; 64 > h;) k = [g = k[3], b(e = k[1], (g = b(b(k[0], [e & (f = k[2]) | ~e & g, g & e | ~g & f, e ^ f ^ g, f ^ (e | ~g)][k = h >> 4]), b(c[h], i[[h, 5 * h + 1, 3 * h + 5, 7 * h][k] % a + m]))) << (k = [7, 12, 17, 22, 5, 9, 14, 20, 4, 11, a, 23, 6, 10, 15, 21][4 * k + h++ % 4]) | g >>> 32 - k), e, f];
                        for (h = 4; h;) l[--h] = b(l[h], k[h])
                    }
                    for (d = ""; 32 > h;) d += (l[h >> 3] >> 4 * (1 ^ 7 & h++) & 15).toString(a);
                    return d
                };
            return e
        }(16),
        hexToString = function(a) {
            for (var b = "", c = "0x" == a.substr(0, 2) ? 2 : 0; c < a.length; c += 2) b += String.fromCharCode(parseInt(a.substr(c, 2), 16));
            return b
        },
        tempcalc = function(a, b) {
            for (var c = "", d = 0; d < a.length; d++) c += String.fromCharCode(a.charCodeAt(d) ^ b.charCodeAt(d % 4));
            return c
        },
        urlenc = function(a, b, c) {
            for (var d, f, g, h, i, j, k, l = "", m = 0; m < a.length;) d = a.charCodeAt(m++), f = a.charCodeAt(m++), g = a.charCodeAt(m++), 15 == m && (l += "A", l += b, l += c), h = d >> 2, i = (3 & d) << 4 | f >> 4, j = (15 & f) << 2 | g >> 6, k = 63 & g, isNaN(f) ? j = k = 64 : isNaN(g) && (k = 64), l = l + _urlStr.charAt(h) + _urlStr.charAt(i) + _urlStr.charAt(j) + _urlStr.charAt(k);
            return l
        },
        u1 = function(a, b) {
            for (var c = "", d = b; d < a.length; d += 2) c += a.charAt(d);
            return c
        },
        createGUID = function(a) {
            a = a || 32;
            for (var b = "", c = 1; a >= c; c++) {
			    var d = Math.floor(16 * Math.random()).toString(16);
			    b += d
			}
			return b
        }

        $(document).ready(function(){
            <!--如果 filename 不为空，说明是请求下一段视频地址-->
            if(filename == ""){
                getVideoInfo()
            } else {
                getKeyInfo()
            }
        });

    </script>
</head>
<body>
<div id="get_info_div"></div>
<div id="get_key_div"></div>
</body>
</html>
